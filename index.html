<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë…¸ë¸” ì¹´ë“œ ìƒì„±ê¸° V14 (Smart Extract)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.11/html-to-image.js"></script>
  <style>
    @import url("https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css");

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      background-color: #e2e8f0;
      font-family: Pretendard, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      color: #333;
    }

    /* --- ì»¨íŠ¸ë¡¤ íŒ¨ë„ --- */
    .editor-area {
      width: 100%;
      padding: 15px;
      background: #fff;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      z-index: 100;
      display: flex;
      flex-direction: column;
      gap: 15px;
      position: sticky;
      top: 0;
      max-height: 60vh;
      overflow-y: auto;
    }

    .main-controls {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      border-bottom: 2px solid #f1f5f9;
      padding-bottom: 10px;
    }

    /* --- ìŠ¤íƒ€ì¼ íŒ¨ë„ --- */
    .style-panel {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      padding: 15px;
      border-radius: 12px;
      display: none;
      flex-direction: column;
      gap: 15px;
    }
    .style-panel.open { display: flex; }

    .style-row {
      display: flex;
      flex-direction: column;
      gap: 5px;
      font-size: 13px;
      font-weight: bold;
      color: #475569;
    }
    
    .color-control-box {
      display: flex;
      flex-direction: column;
      gap: 8px;
      background: #fff;
      border: 1px solid #cbd5e1;
      padding: 8px;
      border-radius: 8px;
    }

    .color-top-row { display: flex; align-items: center; gap: 8px; }

    .true-color-preview {
      width: 36px; height: 36px; border-radius: 6px; border: 1px solid #cbd5e1;
      background-image: linear-gradient(45deg, #ccc 25%, transparent 25%), linear-gradient(-45deg, #ccc 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #ccc 75%), linear-gradient(-45deg, transparent 75%, #ccc 75%);
      background-size: 10px 10px; flex-shrink: 0; position: relative;
    }
    .color-layer { width: 100%; height: 100%; border-radius: 5px; }
    
    input[type="color"] { position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer; bottom: 0; left: 0; }
    .hex-input { border: 1px solid #e2e8f0; border-radius: 4px; padding: 5px; font-family: monospace; font-size: 12px; flex-grow: 1; color: #333; }
    .btn-eyedropper { background: #f1f5f9; border: 1px solid #cbd5e1; border-radius: 4px; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 14px; cursor: pointer; }
    .opacity-row { display: flex; align-items: center; gap: 8px; }
    .opacity-slider { flex-grow: 1; }
    .opacity-val { font-size: 11px; color: #64748b; width: 35px; text-align: right;}

    .preset-container { display: flex; gap: 6px; overflow-x: auto; padding-bottom: 5px; }
    .btn-preset { width: 32px; height: 32px; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; flex-shrink: 0; }

    /* ë¸”ë¡ ìŠ¤íƒ€ì¼ */
    .block-item { background: #fff; border: 1px solid #cbd5e1; border-radius: 8px; padding: 10px; margin-bottom: 10px; }
    .block-item.text-block { border-left: 5px solid #334155; }
    .block-item.image-block { border-left: 5px solid #f59e0b; }
    
    .block-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
    .block-title { font-size: 13px; font-weight: bold; color: #64748b; }
    
    .btn-sm { padding: 5px 8px; font-size: 11px; border-radius: 4px; border: 1px solid #cbd5e1; background: #f8fafc; cursor: pointer; }
    .btn-edit-toggle { background-color: #334155; color: white; border: none; }
    .btn-split { background-color: #e0f2fe; color: #0369a1; border-color: #bae6fd; font-weight: bold; }
    .btn-merge { background-color: #dcfce7; color: #15803d; border-color: #bbf7d0; font-weight: bold; }
    
    /* ìŠ¤ë§ˆíŠ¸ ì¶”ì¶œ ë²„íŠ¼ (í•µì‹¬) */
    .btn-extract { background-color: #818cf8; color: white; border: none; font-weight: bold; box-shadow: 0 2px 4px rgba(99, 102, 241, 0.3); }
    .btn-danger { color: #ef4444; border-color: #ef4444; }

    .code-editor { width: 100%; height: 120px; padding: 10px; border: 1px solid #334155; font-family: monospace; font-size: 12px; display: none; background: #f8fafc; }
    .code-editor.active { display: block; }
    .block-preview-box { padding: 10px; background: #f1f5f9; font-size: 13px; color: #475569; min-height: 40px; display: none; }
    .block-preview-box.active { display: block; }
    .editor-img-preview { max-width: 80px; max-height: 80px; border-radius: 4px; border: 1px solid #ddd; }

    button { cursor: pointer; border: none; }
    .btn-add-text { background: #334155; color: white; padding: 10px; border-radius: 8px; font-weight: bold; width: 48%; }
    .btn-add-image { background: #f59e0b; color: white; padding: 10px; border-radius: 8px; font-weight: bold; width: 48%; }
    .btn-save { background: #3b82f6; color: white; padding: 12px; border-radius: 8px; font-weight: bold; width: 100%; font-size: 16px; margin-top: 10px;}
    .btn-style { background: #64748b; color: white; padding: 6px 12px; border-radius: 6px; font-size: 13px; font-weight: bold; }

    #imgFileInput { display: none; }
    .preview-container { padding: 40px 20px; width: 100%; overflow-x: auto; display: flex; justify-content: center; background-color: #e2e8f0; flex-grow: 1; padding-bottom: 150px; }
    #capture-area { background: transparent; transform-origin: top left; }

    .card-frame { border-radius: 16px; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 4px 24px rgba(0, 0, 0, 0.20); }
    .text-part p { margin: 0 0 1.5em 0; text-align: justify; word-break: keep-all; line-height: 1.8; }
    .highlight-span { -webkit-box-decoration-break: clone; box-decoration-break: clone; color: #0ea5e9; background: #e0f2fe; padding: 2px 6px; border-radius: 4px; }
  </style>
</head>
<body>

  <div class="editor-area">
    <div class="main-controls">
      <div style="display:flex; align-items:center; gap:10px;">
        <span style="font-size: 13px; font-weight: bold;">í­:</span>
        <input type="number" id="cardWidthInput" value="900" step="10" style="width:60px; padding:5px; border:1px solid #ccc; border-radius:4px;"> px
      </div>
      <div style="flex-grow:1"></div>
      <button class="btn-style" onclick="toggleStylePanel()">ğŸ¨ ìŠ¤íƒ€ì¼ ê¾¸ë¯¸ê¸° â–¼</button>
    </div>

    <div id="stylePanel" class="style-panel">
      <div class="style-row">
        <span>ê°ì„± í”„ë¦¬ì…‹:</span>
        <div class="preset-container" id="presetList"></div>
      </div>
      <div class="style-row" style="flex-direction:row; justify-content:space-between; align-items:center;">
        <span>ê·¸ë¼ë°ì´ì…˜ ê°ë„:</span>
        <div style="display:flex; align-items:center; gap:5px;">
          <input type="range" id="gradAngle" min="0" max="360" value="235" oninput="updateCardStyle()" style="width:100px;">
          <span id="gradAngleVal" style="font-size:12px; width:35px; text-align:right;">235Â°</span>
        </div>
      </div>
      <hr style="border:0; border-top:1px dashed #cbd5e1; width:100%; margin:5px 0;">
      
      <div class="style-row">
        <span>ë°°ê²½ ì‹œì‘ìƒ‰ (ìƒë‹¨):</span>
        <div class="color-control-box">
          <div class="color-top-row">
            <div class="true-color-preview"><div id="bg1-preview" class="color-layer" style="background:#fbfdff;"></div><input type="color" id="bg1-picker" value="#fbfdff" oninput="handleColorInput('bg1', this.value)"></div>
            <button class="btn-eyedropper" title="ìŠ¤í¬ì´ë“œ" onclick="activateEyeDropper('bg1')">ğŸ–Šï¸</button>
            <input type="text" id="bg1-text" class="hex-input" value="#fbfdff" onchange="handleTextInput('bg1', this.value)">
          </div>
          <div class="opacity-row"><input type="range" id="bg1-alpha" class="opacity-slider" min="0" max="1" step="0.01" value="1" oninput="handleAlphaInput('bg1', this.value)"><span id="bg1-alpha-val" class="opacity-val">100%</span></div>
        </div>
      </div>
      <div class="style-row">
        <span>ë°°ê²½ ëìƒ‰ (í•˜ë‹¨):</span>
        <div class="color-control-box">
          <div class="color-top-row">
            <div class="true-color-preview"><div id="bg2-preview" class="color-layer" style="background:#f1f5f9;"></div><input type="color" id="bg2-picker" value="#f1f5f9" oninput="handleColorInput('bg2', this.value)"></div>
            <button class="btn-eyedropper" title="ìŠ¤í¬ì´ë“œ" onclick="activateEyeDropper('bg2')">ğŸ–Šï¸</button>
            <input type="text" id="bg2-text" class="hex-input" value="#f1f5f9" onchange="handleTextInput('bg2', this.value)">
          </div>
          <div class="opacity-row"><input type="range" id="bg2-alpha" class="opacity-slider" min="0" max="1" step="0.01" value="1" oninput="handleAlphaInput('bg2', this.value)"><span id="bg2-alpha-val" class="opacity-val">100%</span></div>
        </div>
      </div>
      <div class="style-row">
        <span>ê¸€ììƒ‰:</span>
        <div class="color-control-box">
          <div class="color-top-row">
            <div class="true-color-preview"><div id="text-preview" class="color-layer" style="background:#0f172a;"></div><input type="color" id="text-picker" value="#0f172a" oninput="handleColorInput('text', this.value)"></div>
            <button class="btn-eyedropper" title="ìŠ¤í¬ì´ë“œ" onclick="activateEyeDropper('text')">ğŸ–Šï¸</button>
            <input type="text" id="text-text" class="hex-input" value="#0f172a" onchange="handleTextInput('text', this.value)">
          </div>
          <div class="opacity-row"><input type="range" id="text-alpha" class="opacity-slider" min="0" max="1" step="0.01" value="1" oninput="handleAlphaInput('text', this.value)"><span id="text-alpha-val" class="opacity-val">100%</span></div>
        </div>
      </div>
      <div class="style-row" style="flex-direction:row; justify-content:space-between; align-items:center;">
        <span>ì—¬ë°± (Padding):</span>
        <div style="display:flex; align-items:center; gap:5px;">
          <input type="range" id="paddingRange" min="0" max="100" value="32" oninput="updateCardStyle()" style="width:100px;">
          <span id="paddingVal" style="font-size:12px; width:35px; text-align:right;">32px</span>
        </div>
      </div>
    </div>

    <div id="block-list"></div>

    <div style="display: flex; justify-content: space-between;">
      <button class="btn-add-text" onclick="addTextBlock()">ğŸ“ ê¸€ ì¶”ê°€</button>
      <button class="btn-add-image" onclick="document.getElementById('imgFileInput').click()">ğŸ–¼ï¸ ì‚¬ì§„ ì¶”ê°€</button>
    </div>

    <button class="btn-save" onclick="saveImage()">ğŸ“¸ ì¹´ë“œ ì €ì¥í•˜ê¸°</button>
    <input type="file" id="imgFileInput" accept="image/*">
  </div>

  <div class="preview-container">
    <div id="capture-area"></div>
  </div>

  <script>
    // --- ë°ì´í„° ---
    const presets = [
      { name: 'ê¸°ë³¸(í™”ì´íŠ¸)', c1: '#fbfdff', c2: '#f1f5f9', t: '#0f172a' },
      { name: 'ìƒˆë²½ë…˜(ë¸”ë£¨)', c1: '#e0f2fe', c2: '#f0f9ff', t: '#0c4a6e' },
      { name: 'í”¼ì¹˜(ì›œí†¤)', c1: '#fff1f2', c2: '#fff7ed', t: '#881337' },
      { name: 'ë¯¸ë“œë‚˜ì‡', c1: '#0f172a', c2: '#1e293b', t: '#f8fafc' },
      { name: 'ì˜¤ì…˜(ì²­ëŸ‰)', c1: '#ecfeff', c2: '#cfFAFE', t: '#164e63' },
      { name: 'ì¢…ì´ì§ˆê°', c1: '#fdfbf7', c2: '#f5f5f4', t: '#44403c' },
      { name: 'ë°˜íˆ¬ëª…ë¸”ë™', c1: 'rgba(0,0,0,0.8)', c2: 'rgba(0,0,0,0.9)', t: '#ffffff' }
    ];

    let colors = {
      bg1: { hex: '#fbfdff', alpha: 1 },
      bg2: { hex: '#f1f5f9', alpha: 1 },
      text: { hex: '#0f172a', alpha: 1 }
    };
    let cardParams = { angle: 235, padding: 32 };

    // ì˜ˆì‹œ: ì‚¬ìš©ìê°€ ê²ªì€ ìƒí™©ì„ ì¬í˜„í•œ ì½”ë“œ
    let blocks = [
      {
        type: 'text',
        content: `<div style="max-width: 900px; margin: 1em auto; padding: 2em; color: #0f172a; border-radius: 16px; background: linear-gradient(235deg, #fbfdff 0%, #f1f5f9 100%); box-shadow: 0 4px 24px rgba(0, 0, 0, 0.20)">
  <div style="margin-bottom: 1.5em; padding: 1.5em; background: #f8fafc; border-radius: 16px;">
    <p style="font-weight:bold;">V14 ìŠ¤ë§ˆíŠ¸ ì¶”ì¶œ í…ŒìŠ¤íŠ¸</p>
    <p>ì´ ë°•ìŠ¤ëŠ” 'ê²‰í¬ì¥'ì´ ì”Œì›Œì ¸ ìˆìŠµë‹ˆë‹¤. ìë¥´ê¸° ì „ì— 'ğŸ§™â€â™‚ï¸ ìŠ¤ë§ˆíŠ¸ ì¶”ì¶œ'ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
  </div>
  <p>ê·¸ëŸ¼ ê²‰í¬ì¥ì˜ ìŠ¤íƒ€ì¼ì€ ìœ„ìª½ íŒ¨ë„ë¡œ ì˜®ê²¨ì§€ê³ , ì—¬ê¸°ëŠ” ì•Œë§¹ì´ë§Œ ë‚¨ìŠµë‹ˆë‹¤.</p>
</div>`,
        isEditMode: true 
      }
    ];

    window.onload = function() { initPresets(); renderBlocks(); updatePreview(); }

    // --- ìƒ‰ìƒ í•¸ë“¤ë§ (V13) ---
    function handleColorInput(id, hexVal) { colors[id].hex = hexVal; updateUI(id); updateCardStyle(); }
    function handleAlphaInput(id, alphaVal) { colors[id].alpha = parseFloat(alphaVal); updateUI(id); updateCardStyle(); }
    function handleTextInput(id, strVal) {
      strVal = strVal.trim();
      if (strVal.startsWith('#')) { colors[id].hex = strVal; colors[id].alpha = 1; } 
      else if (strVal.startsWith('rgb')) {
        const match = strVal.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*([\d.]+))?\)/);
        if (match) {
          const toHex = (c) => c.toString(16).padStart(2, '0');
          colors[id].hex = `#${toHex(parseInt(match[1]))}${toHex(parseInt(match[2]))}${toHex(parseInt(match[3]))}`;
          colors[id].alpha = match[4] ? parseFloat(match[4]) : 1;
        }
      }
      updateUI(id); updateCardStyle();
    }
    async function activateEyeDropper(id) {
      if (!window.EyeDropper) { alert("PC í¬ë¡¬/ì—£ì§€ì—ì„œë§Œ ì§€ì›ë©ë‹ˆë‹¤."); return; }
      try { const ed = new EyeDropper(); const res = await ed.open(); handleTextInput(id, res.sRGBHex); } catch(e){}
    }
    function updateUI(id) {
      const c = colors[id];
      const rgba = hexToRgba(c.hex, c.alpha);
      document.getElementById(`${id}-preview`).style.backgroundColor = rgba;
      document.getElementById(`${id}-picker`).value = c.hex.substring(0, 7);
      document.getElementById(`${id}-text`).value = c.alpha === 1 ? c.hex : rgba;
      document.getElementById(`${id}-alpha`).value = c.alpha;
      document.getElementById(`${id}-alpha-val`).innerText = Math.round(c.alpha*100)+'%';
    }
    function hexToRgba(hex, alpha) {
      let r=0,g=0,b=0;
      if (hex.length===4) { r=parseInt(hex[1]+hex[1],16); g=parseInt(hex[2]+hex[2],16); b=parseInt(hex[3]+hex[3],16); }
      else if(hex.length>=7) { r=parseInt(hex.substring(1,3),16); g=parseInt(hex.substring(3,5),16); b=parseInt(hex.substring(5,7),16); }
      return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }
    function updateCardStyle() {
      cardParams.angle = document.getElementById('gradAngle').value;
      cardParams.padding = document.getElementById('paddingRange').value;
      document.getElementById('gradAngleVal').innerText = cardParams.angle + 'Â°';
      document.getElementById('paddingVal').innerText = cardParams.padding + 'px';
      updatePreview();
    }
    function initPresets() {
      const c = document.getElementById('presetList');
      presets.forEach(p => {
        const b = document.createElement('div'); b.className = 'btn-preset';
        b.style.background = `linear-gradient(135deg, ${p.c1}, ${p.c2})`;
        b.onclick = () => { handleTextInput('bg1', p.c1); handleTextInput('bg2', p.c2); handleTextInput('text', p.t); };
        c.appendChild(b);
      });
    }

    // --- ì—ë””í„° ë¡œì§ ---
    function renderBlocks() {
      const container = document.getElementById('block-list'); container.innerHTML = '';
      blocks.forEach((block, index) => {
        const div = document.createElement('div');
        div.className = `block-item ${block.type === 'text' ? 'text-block' : 'image-block'}`;
        const canMergeUp = index > 0 && blocks[index-1].type === 'text' && block.type === 'text';
        
        let innerHTML = `<div class="block-header"><div class="block-title">${block.type==='text'?'ğŸ“ í…ìŠ¤íŠ¸':'ğŸ–¼ï¸ ì´ë¯¸ì§€'} <span style="font-weight:normal;font-size:11px;">#${index+1}</span></div><div class="block-controls"><button class="btn-sm" onclick="moveBlock(${index},-1)">â¬†ï¸</button><button class="btn-sm" onclick="moveBlock(${index},1)">â¬‡ï¸</button><button class="btn-sm btn-danger" onclick="deleteBlock(${index})">ì‚­ì œ</button></div></div>`;
        
        if (block.type === 'text') {
          // ê²‰í¬ì¥(div) ê°ì§€ ë¡œì§
          const hasWrapper = block.content.trim().match(/^<div[^>]*box-shadow[^>]*>([\s\S]*)<\/div>$/i);
          
          innerHTML += `<div style="margin-bottom:5px; display:flex; justify-content:flex-end; gap:5px; flex-wrap:wrap;">
            <button class="btn-sm btn-extract" onclick="smartExtract(${index})" title="ë°°ê²½ ìŠ¤íƒ€ì¼ì„ ì¶”ì¶œí•˜ê³  ì•Œë§¹ì´ë§Œ ë‚¨ê¹ë‹ˆë‹¤">ğŸ§™â€â™‚ï¸ ìŠ¤ë§ˆíŠ¸ ì¶”ì¶œ & í´ë¦°</button>
            ${canMergeUp ? `<button class="btn-sm btn-merge" onclick="mergeUp(${index})">ğŸ§´ í’€ì¹ </button>` : ''}
            ${block.isEditMode ? `<button class="btn-sm btn-split" onmousedown="splitBlock(event, ${index})">âœ‚ï¸ ìë¥´ê¸°</button>` : ''}
            <button class="btn-sm btn-edit-toggle" onclick="toggleEditMode(${index})">${block.isEditMode ? 'ğŸ‘ï¸ ë¯¸ë¦¬ë³´ê¸°' : 'âœï¸ ìˆ˜ì •'}</button>
          </div>
          <div class="block-preview-box ${!block.isEditMode ? 'active' : ''}" onclick="toggleEditMode(${index})">${block.content || '<span style="color:#999">(ë‚´ìš© ì—†ìŒ)</span>'}</div>
          <textarea id="editor-${index}" class="code-editor ${block.isEditMode ? 'active' : ''}" oninput="updateText(${index}, this.value)">${block.content}</textarea>`;
        } else {
          innerHTML += `<div style="margin-bottom:5px;display:flex;justify-content:flex-end;"><button class="btn-sm btn-edit-toggle" onclick="toggleEditMode(${index})">${block.isEditMode?'ğŸ‘ï¸ ì‚¬ì§„':'âš™ï¸ ì„¤ì •'}</button></div><div class="${!block.isEditMode?'active':''}" style="display:${!block.isEditMode?'block':'none'};text-align:center;"><img src="${block.content}" style="max-width:100%;height:auto;border-radius:8px;"></div><div class="${block.isEditMode?'active':''}" style="display:${block.isEditMode?'block':'none'};"><div style="display:flex;gap:10px;align-items:center;margin-bottom:5px;"><img src="${block.content}" class="editor-img-preview"><div><span style="font-size:12px;">ë„ˆë¹„:</span><input type="number" value="${block.width||100}" onchange="updateImageWidth(${index},this.value)" style="width:50px;text-align:center;">%</div></div></div>`;
        }
        div.innerHTML = innerHTML; container.appendChild(div);
      });
      blocks.forEach((block, idx) => { if (block.type === 'text') { const ta = document.getElementById(`editor-${idx}`); if (ta) ta.value = block.content; }});
    }

    // --- V14 í•µì‹¬: ìŠ¤ë§ˆíŠ¸ ì¶”ì¶œ (Magic Extract) ---
    function smartExtract(index) {
      const content = blocks[index].content;
      // 1. DOM Parserë¡œ HTML êµ¬ì¡° í•´ì„
      const parser = new DOMParser();
      const doc = parser.parseFromString(content, 'text/html');
      const wrapper = doc.body.firstElementChild;

      // div íƒœê·¸ê°€ ì•„ë‹ˆê±°ë‚˜, ìŠ¤íƒ€ì¼ì´ ì—†ìœ¼ë©´ ê²½ê³ 
      if (!wrapper || wrapper.tagName !== 'DIV') {
        if(!confirm("ëª…í™•í•œ 'ê²‰í¬ì¥(div)'ì´ ê°ì§€ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\nê·¸ë˜ë„ ê°€ì¥ ë°”ê¹¥ íƒœê·¸ë¥¼ ë²—ê²¨ë‚¼ê¹Œìš”?")) return;
      }

      // 2. ìŠ¤íƒ€ì¼ ì¶”ì¶œ (ìˆìœ¼ë©´)
      if (wrapper.style && confirm("ë°°ê²½ ìŠ¤íƒ€ì¼(ìƒ‰ìƒ, ê·¸ë¼ë°ì´ì…˜)ì„ ì¶”ì¶œí•´ì„œ\nìƒë‹¨ ìŠ¤íƒ€ì¼ íŒ¨ë„ì— ì ìš©í• ê¹Œìš”?")) {
         // ê·¸ë¼ë°ì´ì…˜ ì¶”ì¶œ ì‹œë„ (ê°„ë‹¨í•œ íŒŒì‹±)
         const bg = wrapper.style.background;
         if (bg.includes('linear-gradient')) {
            // ì •ê·œì‹ìœ¼ë¡œ ìƒ‰ìƒ ì½”ë“œ 2ê°œ ì •ë„ë§Œ ë½‘ì•„ë´„ (ì™„ë²½í•˜ì§„ ì•Šì•„ë„ ë„ì›€ë¨)
            const colorMatch = bg.match(/#(?:[0-9a-fA-F]{3}){1,2}/g);
            if (colorMatch && colorMatch.length >= 2) {
               handleTextInput('bg1', colorMatch[0]);
               handleTextInput('bg2', colorMatch[1]);
            }
         }
         
         // í°íŠ¸ ìƒ‰ìƒ ì¶”ì¶œ
         if (wrapper.style.color) handleTextInput('text', wrapper.style.color);
      }

      // 3. ì•Œë§¹ì´(innerHTML)ë§Œ ë‚¨ê¸°ê¸°
      blocks[index].content = wrapper.innerHTML.trim();
      
      renderBlocks();
      updatePreview();
      alert("âœ¨ ê²‰í¬ì¥ì„ ë²—ê²¨ëƒˆìŠµë‹ˆë‹¤!\nì´ì œ ììœ ë¡­ê²Œ [âœ‚ï¸ ìë¥´ê¸°]ë¥¼ í•´ë„ ë©ë‹ˆë‹¤.");
    }

    function updatePreview() {
      const cardWidth = document.getElementById('cardWidthInput').value;
      const captureArea = document.getElementById('capture-area');
      const c1 = hexToRgba(colors.bg1.hex, colors.bg1.alpha);
      const c2 = hexToRgba(colors.bg2.hex, colors.bg2.alpha);
      const tc = hexToRgba(colors.text.hex, colors.text.alpha);
      const frameStyle = `width: ${cardWidth}px; padding: ${cardParams.padding}px; background: linear-gradient(${cardParams.angle}deg, ${c1} 0%, ${c2} 100%); color: ${tc};`;
      let fullHtml = `<div class="card-frame" style="${frameStyle}">`;
      blocks.forEach(block => {
        if (block.type === 'text') fullHtml += `<div class="text-part">${block.content}</div>`;
        else fullHtml += `<div style="margin: 1.5em 0; text-align: center;"><img src="${block.content}" style="width: ${block.width || 100}%; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display:inline-block;"></div>`;
      });
      fullHtml += `</div>`;
      captureArea.innerHTML = fullHtml;
    }

    // ê¸°ì¡´ í•¨ìˆ˜ë“¤ ìœ ì§€
    function updateText(index, val) { blocks[index].content = val; updatePreview(); }
    function splitBlock(event, index) { event.preventDefault(); const textarea = document.getElementById(`editor-${index}`); if (!textarea) return; const currentContent = textarea.value; const cursorPosition = textarea.selectionStart; const firstPart = currentContent.substring(0, cursorPosition); const secondPart = currentContent.substring(cursorPosition); blocks[index].content = firstPart; blocks[index].isEditMode = true; blocks.splice(index + 1, 0, { type: 'text', content: secondPart, isEditMode: true }); renderBlocks(); updatePreview(); }
    function mergeUp(index) { if (index <= 0) return; if(confirm('í•©ì¹˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { blocks[index-1].content += blocks[index].content; blocks.splice(index, 1); renderBlocks(); updatePreview(); } }
    function toggleEditMode(index) { blocks[index].isEditMode = !blocks[index].isEditMode; renderBlocks(); }
    function addTextBlock() { blocks.push({ type: 'text', content: '<p>ìƒˆ ë¬¸ë‹¨</p>', isEditMode: true }); renderBlocks(); updatePreview(); }
    document.getElementById('imgFileInput').addEventListener('change', function(e) { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = function(event) { blocks.push({ type: 'image', content: event.target.result, width: 100, isEditMode: false }); renderBlocks(); updatePreview(); e.target.value = ''; }; reader.readAsDataURL(file); });
    function updateImageWidth(index, val) { blocks[index].width = val; updatePreview(); }
    function deleteBlock(index) { if (confirm('ì‚­ì œ?')) { blocks.splice(index, 1); renderBlocks(); updatePreview(); } }
    function moveBlock(index, dir) { const newIdx = index + dir; if (newIdx < 0 || newIdx >= blocks.length) return; [blocks[index], blocks[newIdx]] = [blocks[newIdx], blocks[index]]; renderBlocks(); updatePreview(); }
    document.getElementById('cardWidthInput').addEventListener('input', updatePreview);
    function toggleStylePanel() { document.getElementById('stylePanel').classList.toggle('open'); }
    function saveImage() { const element = document.getElementById("capture-area").firstElementChild; const btn = document.querySelector('.btn-save'); const txt = btn.innerText; btn.innerText = "â³ ë³€í™˜ ì¤‘..."; htmlToImage.toPng(element, { pixelRatio: 2 }).then(function (dataUrl) { const link = document.createElement('a'); link.download = 'novel_card_' + Date.now() + '.png'; link.href = dataUrl; link.click(); btn.innerText = txt; }).catch(function (error) { alert("ì €ì¥ ì‹¤íŒ¨"); btn.innerText = txt; }); }
  </script>
</body>
</html>
