<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë…¸ë¸” ì¹´ë“œ ìƒì„±ê¸° V11 (Custom Style)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.11/html-to-image.js"></script>
  <style>
    @import url("https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css");

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      background-color: #e2e8f0;
      font-family: Pretendard, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      color: #333;
    }

    /* --- ì»¨íŠ¸ë¡¤ íŒ¨ë„ --- */
    .editor-area {
      width: 100%;
      padding: 15px;
      background: #fff;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      z-index: 100;
      display: flex;
      flex-direction: column;
      gap: 15px;
      position: sticky;
      top: 0;
      max-height: 60vh;
      overflow-y: auto;
    }

    .main-controls {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      border-bottom: 2px solid #f1f5f9;
      padding-bottom: 10px;
    }

    /* ìŠ¤íƒ€ì¼ ì„¤ì • íŒ¨ë„ (ê¸°ë³¸ ìˆ¨ê¹€) */
    .style-panel {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      padding: 15px;
      border-radius: 8px;
      display: none; /* í† ê¸€ë¡œ ì—´ë¦¼ */
      flex-direction: column;
      gap: 10px;
    }
    .style-panel.open { display: flex; }

    .style-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 13px;
      font-weight: bold;
      color: #475569;
    }

    /* ë¸”ë¡ ìŠ¤íƒ€ì¼ */
    .block-item {
      background: #fff;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 10px;
      transition: all 0.2s;
    }
    .block-item.image-block { border-left: 5px solid #f59e0b; }
    .block-item.text-block { border-left: 5px solid #334155; }

    .block-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .block-title {
      font-size: 13px;
      font-weight: bold;
      color: #64748b;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .btn-sm {
      padding: 5px 8px;
      font-size: 11px;
      border-radius: 4px;
      border: 1px solid #cbd5e1;
      background: #f8fafc;
      cursor: pointer;
    }
    .btn-edit-toggle { background-color: #334155; color: white; border: none; }
    .btn-split { background-color: #e0f2fe; color: #0369a1; border-color: #bae6fd; font-weight: bold; }
    .btn-merge { background-color: #dcfce7; color: #15803d; border-color: #bbf7d0; font-weight: bold; }
    .btn-strip { background-color: #fff1f2; color: #be123c; border-color: #fda4af; font-weight: bold; }
    .btn-danger { color: #ef4444; border-color: #ef4444; }

    .code-editor {
      width: 100%;
      height: 120px;
      padding: 10px;
      border: 1px solid #334155;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      resize: vertical;
      background: #f8fafc;
      color: #334155;
      display: none; 
    }
    .code-editor.active { display: block; }

    .block-preview-box {
      padding: 10px;
      background: #f1f5f9;
      border-radius: 4px;
      font-size: 13px;
      color: #475569;
      cursor: pointer;
      min-height: 40px;
      display: none;
    }
    .block-preview-box.active { display: block; }

    .editor-img-preview {
      max-width: 100px;
      max-height: 100px;
      border-radius: 4px;
      border: 1px solid #ddd;
    }

    button { cursor: pointer; border: none; }
    .btn-add-text { background: #334155; color: white; padding: 10px; border-radius: 8px; font-weight: bold; width: 48%; }
    .btn-add-image { background: #f59e0b; color: white; padding: 10px; border-radius: 8px; font-weight: bold; width: 48%; }
    .btn-save { background: #3b82f6; color: white; padding: 12px; border-radius: 8px; font-weight: bold; width: 100%; font-size: 16px; margin-top: 10px;}
    .btn-style { background: #64748b; color: white; padding: 5px 10px; border-radius: 4px; font-size: 12px; }

    #imgFileInput { display: none; }

    .preview-container {
      padding: 40px 20px;
      width: 100%;
      overflow-x: auto;
      display: flex;
      justify-content: center;
      background-color: #e2e8f0;
      flex-grow: 1;
      padding-bottom: 100px;
    }

    #capture-area { background: transparent; transform-origin: top left; }

    /* ê¸°ë³¸ í”„ë ˆì„ (JSë¡œ ìŠ¤íƒ€ì¼ ë®ì–´ì”Œì›€) */
    .card-frame {
      border-radius: 16px; 
      overflow: hidden;
      display: flex;
      flex-direction: column;
      /* ì´ˆê¸°ê°’ */
      padding: 2em;
      background: linear-gradient(235deg, #fbfdff 0%, #f1f5f9 100%);
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.20);
      color: #0f172a;
    }

    .text-part p { margin: 0 0 1.5em 0; text-align: justify; word-break: keep-all; line-height: 1.8; }
    
    .highlight-span {
      -webkit-box-decoration-break: clone; 
      box-decoration-break: clone; 
      color: #0ea5e9; 
      background: #e0f2fe; 
      padding: 2px 6px; 
      border-radius: 4px;
    }
  </style>
</head>
<body>

  <div class="editor-area">
    <div class="main-controls">
      <div style="display:flex; align-items:center; gap:10px;">
        <span style="font-size: 13px; font-weight: bold;">ì¹´ë“œ í­:</span>
        <input type="number" id="cardWidthInput" value="900" step="10" style="width:60px; padding:5px; border:1px solid #ccc; border-radius:4px;"> px
      </div>
      <div style="flex-grow:1"></div>
      <button class="btn-style" onclick="toggleStylePanel()">ğŸ¨ ìŠ¤íƒ€ì¼ ê¾¸ë¯¸ê¸° â–¼</button>
    </div>

    <div id="stylePanel" class="style-panel">
      <div class="style-row">
        <span>ë°°ê²½ ì‹œì‘ìƒ‰ (ìœ„):</span>
        <input type="color" id="bgColor1" value="#fbfdff" onchange="updateCardStyle()">
      </div>
      <div class="style-row">
        <span>ë°°ê²½ ëìƒ‰ (ì•„ë˜):</span>
        <input type="color" id="bgColor2" value="#f1f5f9" onchange="updateCardStyle()">
      </div>
      <div class="style-row">
        <span>ì—¬ë°± (Padding):</span>
        <input type="range" id="paddingRange" min="10" max="60" value="32" oninput="updateCardStyle()">
        <span id="paddingVal" style="font-weight:normal; width:30px; text-align:right;">32px</span>
      </div>
      <div class="style-row">
        <span>ê¸€ììƒ‰:</span>
        <input type="color" id="textColor" value="#0f172a" onchange="updateCardStyle()">
      </div>
    </div>

    <div id="block-list"></div>

    <div style="display: flex; justify-content: space-between;">
      <button class="btn-add-text" onclick="addTextBlock()">ğŸ“ ê¸€ ì¶”ê°€</button>
      <button class="btn-add-image" onclick="document.getElementById('imgFileInput').click()">ğŸ–¼ï¸ ì‚¬ì§„ ì¶”ê°€</button>
    </div>

    <button class="btn-save" onclick="saveImage()">ğŸ“¸ ì¹´ë“œ ì €ì¥í•˜ê¸°</button>
    <input type="file" id="imgFileInput" accept="image/*">
  </div>

  <div class="preview-container">
    <div id="capture-area"></div>
  </div>

  <script>
    // ìŠ¤íƒ€ì¼ ì„¤ì •ê°’
    let cardStyle = {
      color1: '#fbfdff',
      color2: '#f1f5f9',
      padding: 32,
      textColor: '#0f172a'
    };

    let blocks = [
      {
        type: 'text',
        // ì¼ë¶€ëŸ¬ ê²‰í¬ì¥(div)ì´ ìˆëŠ” ì˜ˆì‹œë¥¼ ë„£ìŒ
        content: `<div style="background:#eee; padding:10px;">
  <p style="font-weight:bold;">ì´ ë°•ìŠ¤ëŠ” ì˜ëª» ë³µì‚¬ëœ ê²‰í¬ì¥ì…ë‹ˆë‹¤.</p>
  <p>'í¬ì¥ì§€ ì œê±°' ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ì„¸ìš”.</p>
</div>`,
        isEditMode: false 
      }
    ];

    window.onload = function() { renderBlocks(); updatePreview(); }

    function renderBlocks() {
      const container = document.getElementById('block-list');
      container.innerHTML = '';

      blocks.forEach((block, index) => {
        const div = document.createElement('div');
        div.className = `block-item ${block.type === 'text' ? 'text-block' : 'image-block'}`;
        
        const canMergeUp = index > 0 && blocks[index-1].type === 'text' && block.type === 'text';

        let innerHTML = `
          <div class="block-header">
            <div class="block-title">
              ${block.type === 'text' ? 'ğŸ“ í…ìŠ¤íŠ¸' : 'ğŸ–¼ï¸ ì´ë¯¸ì§€'} 
              <span style="font-weight:normal; font-size:11px;">#${index + 1}</span>
            </div>
            <div class="block-controls">
              <button class="btn-sm" onclick="moveBlock(${index}, -1)">â¬†ï¸</button>
              <button class="btn-sm" onclick="moveBlock(${index}, 1)">â¬‡ï¸</button>
              <button class="btn-sm btn-danger" onclick="deleteBlock(${index})">ì‚­ì œ</button>
            </div>
          </div>
        `;

        if (block.type === 'text') {
          innerHTML += `
            <div style="margin-bottom:5px; display:flex; justify-content:flex-end; gap:5px; flex-wrap:wrap;">
               ${block.isEditMode ? `<button class="btn-sm btn-strip" onclick="stripWrapper(${index})">ğŸ“¦ í¬ì¥ì§€ ì œê±°</button>` : ''}
               
               ${canMergeUp ? `<button class="btn-sm btn-merge" onclick="mergeUp(${index})">ğŸ§´ í’€ì¹ </button>` : ''}
               ${block.isEditMode ? `<button class="btn-sm btn-split" onmousedown="splitBlock(event, ${index})">âœ‚ï¸ ìë¥´ê¸°</button>` : ''}
               
               <button class="btn-sm btn-edit-toggle" onclick="toggleEditMode(${index})">
                 ${block.isEditMode ? 'ğŸ‘ï¸ ë¯¸ë¦¬ë³´ê¸°(ì™„ë£Œ)' : 'âœï¸ ì½”ë“œìˆ˜ì •(í¼ì¹˜ê¸°)'}
               </button>
            </div>

            <div class="block-preview-box ${!block.isEditMode ? 'active' : ''}" onclick="toggleEditMode(${index})">
               ${block.content || '<span style="color:#999">(ë‚´ìš© ì—†ìŒ)</span>'}
            </div>

            <textarea id="editor-${index}" class="code-editor ${block.isEditMode ? 'active' : ''}" 
              oninput="updateText(${index}, this.value)">${block.content}</textarea>
          `;
        } else {
          innerHTML += `
            <div style="margin-bottom:5px; display:flex; justify-content:flex-end; gap:5px;">
               <button class="btn-sm btn-edit-toggle" onclick="toggleEditMode(${index})">
                 ${block.isEditMode ? 'ğŸ‘ï¸ ì‚¬ì§„ë§Œ ë³´ê¸°' : 'âš™ï¸ ì„¤ì •'}
               </button>
            </div>
            <div class="${!block.isEditMode ? 'active' : ''}" style="display:${!block.isEditMode ? 'block' : 'none'}; text-align:center;">
               <img src="${block.content}" style="max-width:100%; height:auto; border-radius:8px;">
            </div>
            <div class="${block.isEditMode ? 'active' : ''}" style="display:${block.isEditMode ? 'block' : 'none'};">
              <div style="display:flex; gap:10px; align-items:center; margin-bottom:5px;">
                 <img src="${block.content}" class="editor-img-preview">
                 <div>
                   <span style="font-size:12px;">ë„ˆë¹„: </span>
                   <input type="number" value="${block.width || 100}" 
                     onchange="updateImageWidth(${index}, this.value)" 
                     style="width:50px; text-align:center;"> %
                 </div>
              </div>
              <textarea class="code-editor active" readonly>${block.content.substring(0, 100)}...</textarea>
            </div>
          `;
        }
        div.innerHTML = innerHTML;
        container.appendChild(div);
      });
    }

    // --- ì¹´ë“œ ë Œë”ë§ (ìŠ¤íƒ€ì¼ ì ìš©) ---
    function updatePreview() {
      const cardWidth = document.getElementById('cardWidthInput').value;
      const captureArea = document.getElementById('capture-area');
      
      // ì‚¬ìš©ì ì§€ì • ìŠ¤íƒ€ì¼ ì ìš©
      const frameStyle = `
        width: ${cardWidth}px;
        padding: ${cardStyle.padding}px;
        background: linear-gradient(235deg, ${cardStyle.color1} 0%, ${cardStyle.color2} 100%);
        color: ${cardStyle.textColor};
      `;

      let fullHtml = `<div class="card-frame" style="${frameStyle}">`;

      blocks.forEach(block => {
        if (block.type === 'text') {
          fullHtml += `<div class="text-part">${block.content}</div>`;
        } else {
          fullHtml += `
            <div style="margin: 1.5em 0; text-align: center;">
              <img src="${block.content}" style="width: ${block.width || 100}%; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display:inline-block;">
            </div>
          `;
        }
      });
      fullHtml += `</div>`;
      captureArea.innerHTML = fullHtml;
    }

    // --- ê¸°ëŠ¥ í•¨ìˆ˜: í¬ì¥ì§€ ì œê±° (Strip Wrapper) ---
    function stripWrapper(index) {
      let content = blocks[index].content.trim();
      
      // 1. <div> íƒœê·¸ë¡œ ì‹œì‘í•˜ê³  </div>ë¡œ ëë‚˜ëŠ”ì§€ í™•ì¸ (ëŒ€ì†Œë¬¸ì ë¬´ì‹œ)
      // ì•„ì£¼ ë‹¨ìˆœí•œ ì •ê·œì‹ì…ë‹ˆë‹¤. ë³µì¡í•œ ì¤‘ì²© êµ¬ì¡°ëŠ” ì•„ë‹ ê±°ë¼ê³  ê°€ì •í•©ë‹ˆë‹¤.
      const wrapperRegex = /^<div[^>]*>([\s\S]*?)<\/div>$/i;
      
      const match = content.match(wrapperRegex);
      
      if (match) {
        if(confirm("ê°€ì¥ ë°”ê¹¥ìª½ <div> íƒœê·¸ë¥¼ ë²—ê²¨ë‚¼ê¹Œìš”?")) {
          // ê·¸ë£¹ 1(ì•Œë§¹ì´)ë§Œ ì¶”ì¶œ
          blocks[index].content = match[1].trim();
          renderBlocks();
          updatePreview();
        }
      } else {
        alert("ë²—ê²¨ë‚¼ ë°”ê¹¥ìª½ <div>ê°€ ë³´ì´ì§€ ì•Šì•„ìš”.\nì´ë¯¸ ë²—ê²¨ì¡Œê±°ë‚˜, í˜•ì‹ì´ ë‹¤ë¥¼ ìˆ˜ ìˆì–´ìš”.");
      }
    }

    // --- ê¸°ëŠ¥ í•¨ìˆ˜: ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸ ---
    function updateCardStyle() {
      cardStyle.color1 = document.getElementById('bgColor1').value;
      cardStyle.color2 = document.getElementById('bgColor2').value;
      cardStyle.padding = document.getElementById('paddingRange').value;
      cardStyle.textColor = document.getElementById('textColor').value;
      
      document.getElementById('paddingVal').innerText = cardStyle.padding + 'px';
      
      updatePreview();
    }

    function toggleStylePanel() {
      const panel = document.getElementById('stylePanel');
      panel.classList.toggle('open');
    }

    // --- ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€ ---
    function splitBlock(event, index) {
      event.preventDefault(); 
      const textarea = document.getElementById(`editor-${index}`);
      if (!textarea) return;
      const cursorPosition = textarea.selectionStart;
      const fullText = blocks[index].content;
      const firstPart = fullText.substring(0, cursorPosition);
      const secondPart = fullText.substring(cursorPosition);
      blocks[index].content = firstPart;
      blocks[index].isEditMode = true; 
      blocks.splice(index + 1, 0, { type: 'text', content: secondPart, isEditMode: true });
      renderBlocks(); updatePreview();
    }
    function mergeUp(index) {
      if (index <= 0) return;
      if(confirm('ìœ„ìª½ê³¼ í•©ì¹˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        blocks[index-1].content += blocks[index].content;
        blocks.splice(index, 1);
        renderBlocks(); updatePreview();
      }
    }
    function toggleEditMode(index) { blocks[index].isEditMode = !blocks[index].isEditMode; renderBlocks(); }
    function addTextBlock() { blocks.push({ type: 'text', content: '<p>ìƒˆ ë¬¸ë‹¨</p>', isEditMode: true }); renderBlocks(); updatePreview(); }
    function updateText(index, val) { blocks[index].content = val; updatePreview(); }
    function updateImageWidth(index, val) { blocks[index].width = val; updatePreview(); }
    function deleteBlock(index) { if (confirm('ì‚­ì œ?')) { blocks.splice(index, 1); renderBlocks(); updatePreview(); } }
    function moveBlock(index, dir) {
      const newIdx = index + dir;
      if (newIdx < 0 || newIdx >= blocks.length) return;
      [blocks[index], blocks[newIdx]] = [blocks[newIdx], blocks[index]];
      renderBlocks(); updatePreview();
    }
    document.getElementById('imgFileInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(event) {
        blocks.push({ type: 'image', content: event.target.result, width: 100, isEditMode: false });
        renderBlocks(); updatePreview(); e.target.value = '';
      };
      reader.readAsDataURL(file);
    });
    document.getElementById('cardWidthInput').addEventListener('input', updatePreview);
    function saveImage() {
      const element = document.getElementById("capture-area").firstElementChild;
      const btn = document.querySelector('.btn-save');
      const txt = btn.innerText; btn.innerText = "â³ ë³€í™˜ ì¤‘...";
      htmlToImage.toPng(element, { pixelRatio: 2 }).then(function (dataUrl) {
          const link = document.createElement('a'); link.download = 'novel_card_' + Date.now() + '.png'; link.href = dataUrl; link.click(); btn.innerText = txt;
        }).catch(function (error) { alert("ì €ì¥ ì‹¤íŒ¨"); btn.innerText = txt; });
    }
  </script>
</body>
</html>
