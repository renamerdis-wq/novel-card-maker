<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë…¸ë¸” ì¹´ë“œ ìƒì„±ê¸° V9 (Merge Feature)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.11/html-to-image.js"></script>
  <style>
    @import url("https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css");

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      background-color: #f1f5f9;
      font-family: Pretendard, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      color: #333;
    }

    /* --- ì»¨íŠ¸ë¡¤ íŒ¨ë„ --- */
    .editor-area {
      width: 100%;
      padding: 15px;
      background: #fff;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      z-index: 100;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .main-controls {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      border-bottom: 2px solid #e2e8f0;
      padding-bottom: 10px;
      margin-bottom: 10px;
    }

    .block-item {
      background: #fff;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 10px;
      transition: all 0.2s;
    }
    .block-item.image-block { border-left: 5px solid #f59e0b; }
    .block-item.text-block { border-left: 5px solid #334155; }

    .block-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .block-title {
      font-size: 13px;
      font-weight: bold;
      color: #64748b;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .block-controls {
      display: flex;
      gap: 5px;
    }

    .btn-sm {
      padding: 5px 8px;
      font-size: 12px;
      border-radius: 4px;
      border: 1px solid #cbd5e1;
      background: #f8fafc;
      cursor: pointer;
    }
    
    /* ê°€ìœ„/í’€ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .btn-split { background-color: #e0f2fe; color: #0369a1; border-color: #bae6fd; font-weight: bold; }
    .btn-merge { background-color: #dcfce7; color: #15803d; border-color: #bbf7d0; font-weight: bold; }
    .btn-danger { color: #ef4444; border-color: #ef4444; }

    .text-editor {
      width: 100%;
      height: 120px;
      padding: 10px;
      border: 1px solid #e2e8f0;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      resize: vertical;
      display: block;
    }
    .text-editor.folded { display: none; }
    
    .text-preview-snippet {
      font-size: 12px;
      color: #94a3b8;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      padding: 8px;
      background: #f1f5f9;
      border-radius: 4px;
      cursor: pointer;
    }

    .editor-img-preview {
      max-width: 100px;
      max-height: 100px;
      border-radius: 4px;
      border: 1px solid #ddd;
      display: block;
    }

    button { cursor: pointer; border: none; }
    .btn-add-text { background: #334155; color: white; padding: 10px; border-radius: 8px; font-weight: bold; width: 48%; }
    .btn-add-image { background: #f59e0b; color: white; padding: 10px; border-radius: 8px; font-weight: bold; width: 48%; }
    .btn-save { background: #3b82f6; color: white; padding: 12px; border-radius: 8px; font-weight: bold; width: 100%; font-size: 16px; margin-top: 10px;}

    #imgFileInput { display: none; }

    .preview-container {
      padding: 40px 20px;
      width: 100%;
      overflow-x: auto;
      display: flex;
      justify-content: center;
      background-color: #e2e8f0;
      flex-grow: 1;
    }

    #capture-area { background: transparent; transform-origin: top left; }

    .card-base {
      padding: 2em; 
      color: #0f172a; 
      font-size: 15px; 
      font-weight: 500; 
      line-height: 1.8; 
      border-radius: 16px; 
      background: linear-gradient(235deg, #fbfdff 0%, #f1f5f9 100%); 
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.20);
      overflow: hidden;
    }
  </style>
</head>
<body>

  <div class="editor-area">
    <div class="main-controls">
      <span style="font-size: 13px; font-weight: bold;">ì¹´ë“œ í­:</span>
      <input type="number" id="cardWidthInput" value="900" step="10" style="width:60px; padding:5px; border:1px solid #ccc; border-radius:4px;"> px
    </div>

    <div id="block-list"></div>

    <div style="display: flex; justify-content: space-between;">
      <button class="btn-add-text" onclick="addTextBlock()">ğŸ“ ê¸€ ì¶”ê°€</button>
      <button class="btn-add-image" onclick="document.getElementById('imgFileInput').click()">ğŸ–¼ï¸ ì‚¬ì§„ ì¶”ê°€</button>
    </div>

    <button class="btn-save" onclick="saveImage()">ğŸ“¸ ì¹´ë“œ ì €ì¥í•˜ê¸°</button>
    <input type="file" id="imgFileInput" accept="image/*">
  </div>

  <div class="preview-container">
    <div id="capture-area"></div>
  </div>

  <script>
    let blocks = [
      {
        type: 'text',
        content: `<div style="margin-bottom: 1.5em; padding: 1.5em; background: #f8fafc; border-radius: 16px;">
  <p style="margin: 0; font-size: 1.2em; font-weight: 800; color: #0f172a;">í’€ì¹  ê¸°ëŠ¥ ì¶”ê°€ë¨!</p>
</div>
<p>ì´ ë¸”ë¡ì„ ì˜ëë‹¤ê°€ ë‹¤ì‹œ í•©ì³ë³´ì„¸ìš”.</p>
<p>ê°€ìœ„ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì˜ë¦¬ê³ , í’€ì¹  ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ìœ„ë‘ í•©ì³ì§‘ë‹ˆë‹¤.</p>`,
        isOpen: true 
      }
    ];

    window.onload = function() { renderBlocks(); updatePreview(); }

    function renderBlocks() {
      const container = document.getElementById('block-list');
      container.innerHTML = '';

      blocks.forEach((block, index) => {
        const div = document.createElement('div');
        div.className = `block-item ${block.type === 'text' ? 'text-block' : 'image-block'}`;
        
        // ì´ì „ ë¸”ë¡ì´ í…ìŠ¤íŠ¸ì¸ì§€ í™•ì¸ (í’€ì¹  ë²„íŠ¼ í‘œì‹œ ì¡°ê±´)
        const canMergeUp = index > 0 && blocks[index-1].type === 'text' && block.type === 'text';

        let innerHTML = `
          <div class="block-header">
            <div class="block-title">
              ${block.type === 'text' ? 'ğŸ“ í…ìŠ¤íŠ¸' : 'ğŸ–¼ï¸ ì´ë¯¸ì§€'} 
              <span style="font-weight:normal; font-size:11px;">#${index + 1}</span>
            </div>
            <div class="block-controls">
              <button class="btn-sm" onclick="moveBlock(${index}, -1)">â¬†ï¸</button>
              <button class="btn-sm" onclick="moveBlock(${index}, 1)">â¬‡ï¸</button>
              <button class="btn-sm btn-danger" onclick="deleteBlock(${index})">ì‚­ì œ</button>
            </div>
          </div>
        `;

        if (block.type === 'text') {
          innerHTML += `
            <div style="margin-bottom:5px; display:flex; justify-content:flex-end; gap:5px; flex-wrap:wrap;">
               ${canMergeUp ? `<button class="btn-sm btn-merge" onclick="mergeUp(${index})">ğŸ§´ í’€ì¹ í•˜ê¸° (ìœ„ì™€ í•©ì²´)</button>` : ''}
               ${block.isOpen ? `<button class="btn-sm btn-split" onmousedown="splitBlock(event, ${index})">âœ‚ï¸ ìë¥´ê¸°</button>` : ''}
               <button class="btn-sm" onclick="toggleFold(${index})">
                 ${block.isOpen ? 'ğŸ”¼ ì ‘ê¸°' : 'ğŸ”½ í¼ì¹˜ê¸°'}
               </button>
            </div>
            ${!block.isOpen ? `<div class="text-preview-snippet" onclick="toggleFold(${index})">${block.content.substring(0, 50)}...</div>` : ''}
            <textarea id="editor-${index}" class="text-editor ${block.isOpen ? '' : 'folded'}" 
              oninput="updateText(${index}, this.value)">${block.content}</textarea>
          `;
        } else {
          innerHTML += `
            <div style="display:flex; gap:10px; align-items:center;">
              <img src="${block.content}" class="editor-img-preview">
              <div>
                <span style="font-size:12px;">í¬ê¸°: </span>
                <input type="number" value="${block.width || 100}" 
                  onchange="updateImageWidth(${index}, this.value)" 
                  style="width:50px; text-align:center;"> %
              </div>
            </div>
          `;
        }

        div.innerHTML = innerHTML;
        container.appendChild(div);
      });
    }

    function updatePreview() {
      const cardWidth = document.getElementById('cardWidthInput').value;
      const captureArea = document.getElementById('capture-area');
      
      let fullHtml = `<div class="card-base" style="width: ${cardWidth}px;">`;

      blocks.forEach(block => {
        if (block.type === 'text') {
          fullHtml += `<div class="text-part">${block.content}</div>`;
        } else {
          fullHtml += `
            <div style="margin: 1.5em 0; text-align: center;">
              <img src="${block.content}" style="width: ${block.width || 100}%; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display:inline-block;">
            </div>
          `;
        }
      });

      fullHtml += `</div>`;
      captureArea.innerHTML = fullHtml;
    }

    // --- í•µì‹¬ ê¸°ëŠ¥: ìë¥´ê¸° (Split) ---
    function splitBlock(event, index) {
      event.preventDefault(); 
      const textarea = document.getElementById(`editor-${index}`);
      if (!textarea) return;

      const cursorPosition = textarea.selectionStart;
      const fullText = blocks[index].content;
      
      const firstPart = fullText.substring(0, cursorPosition);
      const secondPart = fullText.substring(cursorPosition);

      blocks[index].content = firstPart;

      const newBlock = { type: 'text', content: secondPart, isOpen: true };
      blocks.splice(index + 1, 0, newBlock);

      renderBlocks(); updatePreview();
    }

    // --- í•µì‹¬ ê¸°ëŠ¥: í’€ì¹ í•˜ê¸° (Merge Up) ---
    function mergeUp(index) {
      if (index <= 0) return;
      if (blocks[index].type !== 'text' || blocks[index-1].type !== 'text') return;

      if(confirm('ìœ„ìª½ í…ìŠ¤íŠ¸ ë¸”ë¡ê³¼ í•©ì¹˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        // ìœ„ì˜ ë¸”ë¡ ë‚´ìš© ë’¤ì— í˜„ì¬ ë‚´ìš©ì„ ê°–ë‹¤ ë¶™ì„
        blocks[index-1].content += blocks[index].content;
        
        // í˜„ì¬ ë¸”ë¡ ì‚­ì œ
        blocks.splice(index, 1);
        
        renderBlocks(); updatePreview();
      }
    }

    function addTextBlock() {
      blocks.push({ type: 'text', content: '<p>ìƒˆë¡œìš´ ë‚´ìš©</p>', isOpen: true });
      renderBlocks(); updatePreview();
    }

    document.getElementById('imgFileInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(event) {
        blocks.push({ type: 'image', content: event.target.result, width: 100 });
        renderBlocks(); updatePreview();
        e.target.value = '';
      };
      reader.readAsDataURL(file);
    });

    function updateText(index, val) { blocks[index].content = val; updatePreview(); }
    function updateImageWidth(index, val) { blocks[index].width = val; updatePreview(); }
    function toggleFold(index) { blocks[index].isOpen = !blocks[index].isOpen; renderBlocks(); }
    function deleteBlock(index) { if (confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { blocks.splice(index, 1); renderBlocks(); updatePreview(); } }
    
    function moveBlock(index, direction) {
      const newIndex = index + direction;
      if (newIndex < 0 || newIndex >= blocks.length) return;
      [blocks[index], blocks[newIndex]] = [blocks[newIndex], blocks[index]];
      renderBlocks(); updatePreview();
    }
    document.getElementById('cardWidthInput').addEventListener('input', updatePreview);

    function saveImage() {
      const element = document.getElementById("capture-area").firstElementChild;
      const saveBtn = document.querySelector('.btn-save');
      const originalText = saveBtn.innerText;
      saveBtn.innerText = "â³ ë³€í™˜ ì¤‘...";
      htmlToImage.toPng(element, { pixelRatio: 2 })
        .then(function (dataUrl) {
          const link = document.createElement('a');
          link.download = 'novel_card_' + new Date().getTime() + '.png';
          link.href = dataUrl; link.click(); saveBtn.innerText = originalText;
        })
        .catch(function (error) { alert("ì €ì¥ ì‹¤íŒ¨"); saveBtn.innerText = originalText; });
    }
  </script>
</body>
</html>
