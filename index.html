<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë…¸ë¸” ì¹´ë“œ ìƒì„±ê¸° V18 (Background Image)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.11/html-to-image.js"></script>
  <style>
    /* í°íŠ¸ ë¡œë“œ */
    @import url('https://fonts.googleapis.com/css2?family=Gowun+Batang&family=Gowun+Dodum&family=Nanum+Gothic&family=Nanum+Myeongjo&family=Noto+Sans+KR:wght@400;700&family=Noto+Serif+KR:wght@400;700&display=swap');
    @import url("https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css");
    @import url('https://cdn.jsdelivr.net/npm/ridibatang@1.0.0/dist/ridibatang.css');
    @font-face { font-family: 'KoPub World Batang'; font-weight: 400; src: url('https://cdn.jsdelivr.net/npm/font-kopubworld@1.0.0/fonts/kopubworld-batang-pro-medium.woff2') format('woff2'); }
    @font-face { font-family: 'MaruBuri'; src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_20-10-21@1.0/MaruBuri-Regular.woff') format('woff'); font-weight: normal; font-style: normal; }
    @font-face { font-family: 'Cafe24SsurroundAir'; src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2105_2@1.0/Cafe24SsurroundAir.woff') format('woff'); font-weight: normal; font-style: normal; }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      background-color: #e2e8f0;
      font-family: 'Pretendard', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      color: #333;
    }

    /* --- ì—ë””í„° ì˜ì—­ --- */
    .editor-area {
      width: 100%;
      background: #fff;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      z-index: 1000;
      position: sticky;
      top: 0;
      display: flex;
      flex-direction: column;
      border-bottom: 1px solid #cbd5e1;
    }

    .editor-header-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 15px;
      background: #f8fafc;
      border-bottom: 1px solid #e2e8f0;
      cursor: pointer;
    }
    .editor-title { font-size: 14px; font-weight: bold; color: #334155; display: flex; align-items: center; gap: 5px; }
    .header-actions { display: flex; gap: 8px; }
    .btn-header { padding: 6px 10px; font-size: 12px; border-radius: 6px; border: 1px solid #cbd5e1; background: #fff; font-weight: bold; color: #475569; }
    .btn-header.save { background: #3b82f6; color: white; border: none; }

    .editor-content-wrapper {
      padding: 15px;
      max-height: 60vh;
      overflow-y: auto;
      transition: all 0.3s ease;
    }
    .editor-content-wrapper.collapsed { display: none; }

    .main-controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px; margin-bottom: 15px; }
    
    /* ìŠ¤íƒ€ì¼ íŒ¨ë„ */
    .style-panel { background: #f8fafc; border: 1px solid #e2e8f0; padding: 15px; border-radius: 12px; display: none; flex-direction: column; gap: 15px; margin-bottom: 15px;}
    .style-panel.open { display: flex; }
    
    /* V18: íƒ­ ë©”ë‰´ */
    .tab-menu { display: flex; gap: 5px; margin-bottom: 10px; border-bottom: 1px solid #cbd5e1; padding-bottom: 5px; }
    .tab-btn {
      flex: 1; padding: 8px; border: none; background: #e2e8f0; border-radius: 6px 6px 0 0; 
      font-size: 13px; font-weight: bold; color: #64748b; cursor: pointer;
    }
    .tab-btn.active { background: #fff; color: #3b82f6; border: 1px solid #cbd5e1; border-bottom: none; }
    
    /* ëª¨ë“œë³„ ì„¹ì…˜ */
    .bg-mode-section { display: none; flex-direction: column; gap: 15px; }
    .bg-mode-section.active { display: flex; }

    .style-row { display: flex; flex-direction: column; gap: 6px; font-size: 13px; font-weight: bold; color: #475569; }
    
    /* ì˜¤ë²„ë ˆì´ ì»¬ëŸ¬ ë²„íŠ¼ */
    .overlay-colors { display: flex; gap: 10px; }
    .btn-overlay-color {
      width: 30px; height: 30px; border-radius: 50%; border: 2px solid #e2e8f0; cursor: pointer; position: relative;
    }
    .btn-overlay-color.selected::after {
      content: 'âœ”'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #fff; font-size: 12px;
    }
    /* íŠ¹ì • ìƒ‰ìƒ ìŠ¤íƒ€ì¼ */
    .overlay-black { background: #000; }
    .overlay-navy { background: #0f172a; }
    .overlay-white { background: #fff; }
    .overlay-white.selected::after { color: #000; }

    /* ì´ë¯¸ì§€ ë§ì¶¤ ë²„íŠ¼ */
    .fit-options { display: flex; gap: 5px; }
    .btn-fit { flex: 1; padding: 8px; border: 1px solid #cbd5e1; background: #fff; border-radius: 6px; font-size: 12px; cursor: pointer; }
    .btn-fit.active { background: #3b82f6; color: white; border-color: #3b82f6; }

    /* ë‚˜ë¨¸ì§€ ê¸°ì¡´ ìŠ¤íƒ€ì¼ */
    .font-selector { width: 100%; padding: 10px; border: 1px solid #3b82f6; border-radius: 6px; font-size: 14px; background-color: #eff6ff; color: #1e3a8a; font-weight: bold; cursor: pointer; }
    .color-control-box { display: flex; flex-direction: column; gap: 8px; background: #fff; border: 1px solid #cbd5e1; padding: 10px; border-radius: 8px; }
    .color-top-row { display: flex; align-items: center; gap: 8px; }
    .true-color-preview { width: 40px; height: 40px; border-radius: 6px; border: 1px solid #cbd5e1; background-image: linear-gradient(45deg, #ccc 25%, transparent 25%), linear-gradient(-45deg, #ccc 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #ccc 75%), linear-gradient(-45deg, transparent 75%, #ccc 75%); background-size: 10px 10px; flex-shrink: 0; position: relative; }
    .color-layer { width: 100%; height: 100%; border-radius: 5px; }
    input[type="color"] { position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer; bottom: 0; left: 0; }
    .hex-input { border: 1px solid #e2e8f0; border-radius: 4px; padding: 6px; font-family: monospace; font-size: 12px; flex-grow: 1; color: #333; }
    .btn-eyedropper { background: #f1f5f9; border: 1px solid #cbd5e1; border-radius: 4px; width: 34px; height: 34px; display: flex; align-items: center; justify-content: center; font-size: 16px; cursor: pointer; }
    .opacity-row { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .opacity-slider { flex-grow: 1; }
    .opacity-val { font-size: 11px; color: #64748b; width: 35px; text-align: right;}
    .alpha-btn-group { display: flex; gap: 4px; }
    .btn-alpha { padding: 2px 6px; font-size: 10px; border: 1px solid #cbd5e1; background: #fff; border-radius: 4px; cursor: pointer; }
    
    .preset-container { display: flex; gap: 6px; overflow-x: auto; padding-bottom: 5px; align-items: center; }
    .btn-preset { width: 32px; height: 32px; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; flex-shrink: 0; }
    .btn-preset.recent { border: 2px solid #3b82f6; }
    .preset-tools { display: flex; gap: 5px; margin-top: 5px; }
    .btn-tool { padding: 6px 10px; font-size: 12px; background: #334155; color: white; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 4px; }
    .btn-tool-secondary { background: #fff; color: #334155; border: 1px solid #cbd5e1; }

    .block-item { background: #fff; border: 1px solid #cbd5e1; border-radius: 8px; padding: 10px; margin-bottom: 10px; }
    .block-item.text-block { border-left: 5px solid #334155; }
    .block-item.image-block { border-left: 5px solid #f59e0b; }
    .block-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
    .block-title { font-size: 13px; font-weight: bold; color: #64748b; }
    .btn-sm { padding: 5px 8px; font-size: 11px; border-radius: 4px; border: 1px solid #cbd5e1; background: #f8fafc; cursor: pointer; }
    .btn-edit-toggle { background-color: #334155; color: white; border: none; }
    .btn-split { background-color: #e0f2fe; color: #0369a1; border-color: #bae6fd; font-weight: bold; }
    .btn-merge { background-color: #dcfce7; color: #15803d; border-color: #bbf7d0; font-weight: bold; }
    .btn-extract { background-color: #818cf8; color: white; border: none; font-weight: bold; box-shadow: 0 2px 4px rgba(99, 102, 241, 0.3); }
    .btn-danger { color: #ef4444; border-color: #ef4444; }
    .code-editor { width: 100%; height: 120px; padding: 10px; border: 1px solid #334155; font-family: monospace; font-size: 12px; display: none; background: #f8fafc; }
    .code-editor.active { display: block; }
    .block-preview-box { padding: 10px; background: #f1f5f9; font-size: 13px; color: #475569; min-height: 40px; display: none; }
    .block-preview-box.active { display: block; }
    .editor-img-preview { max-width: 80px; max-height: 80px; border-radius: 4px; border: 1px solid #ddd; }
    button { cursor: pointer; border: none; }
    .btn-add-text { background: #334155; color: white; padding: 10px; border-radius: 8px; font-weight: bold; width: 48%; }
    .btn-add-image { background: #f59e0b; color: white; padding: 10px; border-radius: 8px; font-weight: bold; width: 48%; }
    .btn-save { background: #3b82f6; color: white; padding: 12px; border-radius: 8px; font-weight: bold; width: 100%; font-size: 16px; margin-top: 10px;}
    .btn-style { background: #64748b; color: white; padding: 6px 12px; border-radius: 6px; font-size: 13px; font-weight: bold; }
    
    #imgFileInput, #presetFileInput, #bgImgFileInput { display: none; }
    .preview-container { padding: 40px 20px; width: 100%; overflow-x: auto; display: flex; justify-content: center; background-color: #e2e8f0; flex-grow: 1; padding-bottom: 150px; }
    #capture-area { background: transparent; transform-origin: top left; }
    .card-frame { border-radius: 16px; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 4px 24px rgba(0, 0, 0, 0.20); }
    .text-part p { margin: 0 0 1.5em 0; text-align: justify; word-break: keep-all; line-height: 1.8; }
    .highlight-span { -webkit-box-decoration-break: clone; box-decoration-break: clone; color: #0ea5e9; background: #e0f2fe; padding: 2px 6px; border-radius: 4px; }
  </style>
</head>
<body>

  <div class="editor-area">
    <div class="editor-header-bar" onclick="toggleEditor()">
      <div class="editor-title">
        <span id="foldIcon">ğŸ”½</span>
        <span>í¸ì§‘ê¸° & ì„¤ì •</span>
      </div>
      <div class="header-actions">
        <button class="btn-header save" onclick="event.stopPropagation(); saveImage()">ğŸ“¸ ë¹ ë¥¸ ì €ì¥</button>
      </div>
    </div>

    <div id="editorContent" class="editor-content-wrapper">
      <div class="main-controls">
        <div style="display:flex; align-items:center; gap:10px;">
          <span style="font-size: 13px; font-weight: bold;">í­:</span>
          <input type="number" id="cardWidthInput" value="900" step="10" style="width:60px; padding:5px; border:1px solid #ccc; border-radius:4px;"> px
        </div>
        <div style="flex-grow:1"></div>
        <button class="btn-style" onclick="toggleStylePanel()">ğŸ¨ ìŠ¤íƒ€ì¼ ê¾¸ë¯¸ê¸° â–¼</button>
      </div>

      <div id="stylePanel" class="style-panel">
        
        <div class="style-row">
          <span>ğŸ¨ í”„ë¦¬ì…‹ & ì €ì¥:</span>
          <div class="preset-container" id="presetList"></div>
          <div class="preset-tools">
            <button class="btn-tool btn-tool-secondary" onclick="savePresetToFile()">ğŸ’¾ íŒŒì¼ ì €ì¥</button>
            <button class="btn-tool btn-tool-secondary" onclick="document.getElementById('presetFileInput').click()">ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <input type="file" id="presetFileInput" accept=".json" onchange="loadPresetFromFile(this)">
          </div>
        </div>

        <div class="style-row">
          <span>ğŸ”¤ í°íŠ¸ ì„ íƒ:</span>
          <select id="fontSelect" class="font-selector" onchange="updateCardStyle()">
            <optgroup label="ëª…ì¡°/ë°”íƒ•">
              <option value="'RIDIBatang', serif">ë¦¬ë””ë°”íƒ• (ì „ìì±… í‘œì¤€)</option>
              <option value="'KoPub World Batang', serif">KoPub ë°”íƒ• (ê°€ë…ì„± ìµœê³ )</option>
              <option value="'MaruBuri', serif">ë§ˆë£¨ë¶€ë¦¬</option>
              <option value="'Gowun Batang', serif">ê³ ìš´ë°”íƒ•</option>
            </optgroup>
            <optgroup label="ê³ ë”•/ë‹ì›€">
              <option value="Pretendard, sans-serif" selected>í”„ë¦¬í…ë‹¤ë“œ</option>
              <option value="'Noto Sans KR', sans-serif">Noto Sans</option>
              <option value="'Gowun Dodum', sans-serif">ê³ ìš´ë‹ì›€</option>
            </optgroup>
          </select>
        </div>
        <hr style="border:0; border-top:1px dashed #cbd5e1; width:100%; margin:5px 0;">

        <div class="style-row">
          <div class="tab-menu">
            <button class="tab-btn active" id="tabGradient" onclick="switchBgMode('gradient')">ğŸŒˆ ê·¸ë¼ë°ì´ì…˜</button>
            <button class="tab-btn" id="tabImage" onclick="switchBgMode('image')">ğŸ–¼ï¸ ë°°ê²½ ì´ë¯¸ì§€</button>
          </div>
        </div>

        <div id="sectionGradient" class="bg-mode-section active">
          <div class="style-row"><span>ë°°ê²½ ì‹œì‘ìƒ‰:</span><div class="color-control-box"><div class="color-top-row"><div class="true-color-preview"><div id="bg1-preview" class="color-layer" style="background:#fbfdff;"></div><input type="color" id="bg1-picker" value="#fbfdff" oninput="handleColorInput('bg1', this.value)"></div><button class="btn-eyedropper" onclick="activateEyeDropper('bg1')">ğŸ–Šï¸</button><input type="text" id="bg1-text" class="hex-input" value="#fbfdff" onchange="handleTextInput('bg1', this.value)"></div><div class="opacity-row"><input type="range" id="bg1-alpha" class="opacity-slider" min="0" max="1" step="0.01" value="1" oninput="handleAlphaInput('bg1', this.value)"><span id="bg1-alpha-val" class="opacity-val">100%</span></div></div></div>
          <div class="style-row"><span>ë°°ê²½ ëìƒ‰:</span><div class="color-control-box"><div class="color-top-row"><div class="true-color-preview"><div id="bg2-preview" class="color-layer" style="background:#f1f5f9;"></div><input type="color" id="bg2-picker" value="#f1f5f9" oninput="handleColorInput('bg2', this.value)"></div><button class="btn-eyedropper" onclick="activateEyeDropper('bg2')">ğŸ–Šï¸</button><input type="text" id="bg2-text" class="hex-input" value="#f1f5f9" onchange="handleTextInput('bg2', this.value)"></div><div class="opacity-row"><input type="range" id="bg2-alpha" class="opacity-slider" min="0" max="1" step="0.01" value="1" oninput="handleAlphaInput('bg2', this.value)"><span id="bg2-alpha-val" class="opacity-val">100%</span></div></div></div>
          <div class="style-row" style="flex-direction:row; justify-content:space-between; align-items:center;"><span>ê·¸ë¼ë°ì´ì…˜ ê°ë„:</span><div style="display:flex; align-items:center; gap:5px;"><input type="range" id="gradAngle" min="0" max="360" value="235" oninput="updateCardStyle()" style="width:100px;"><span id="gradAngleVal" style="font-size:12px; width:35px; text-align:right;">235Â°</span></div></div>
        </div>

        <div id="sectionImage" class="bg-mode-section">
          <div class="style-row">
            <span>ë°°ê²½ ì´ë¯¸ì§€ ì—…ë¡œë“œ:</span>
            <button class="btn-tool" onclick="document.getElementById('bgImgFileInput').click()" style="width:100%; justify-content:center;">ğŸ“‚ ì´ë¯¸ì§€ ì„ íƒ</button>
            <input type="file" id="bgImgFileInput" accept="image/*" onchange="handleBgImageUpload(this)">
          </div>

          <div class="style-row">
            <span>ì´ë¯¸ì§€ ë§ì¶¤ (Size):</span>
            <div class="fit-options">
              <button class="btn-fit active" id="btnCover" onclick="setBgSize('cover')">ì±„ì›€ (Cover)</button>
              <button class="btn-fit" id="btnContain" onclick="setBgSize('contain')">ë§ì¶¤ (Fit)</button>
            </div>
          </div>

          <div class="style-row">
            <span>ì˜¤ë²„ë ˆì´ ìƒ‰ìƒ (Overlay):</span>
            <div class="overlay-colors">
              <div class="btn-overlay-color overlay-black selected" onclick="setOverlayColor('#000000', this)"></div>
              <div class="btn-overlay-color overlay-navy" onclick="setOverlayColor('#0f172a', this)"></div>
              <div class="btn-overlay-color overlay-white" onclick="setOverlayColor('#ffffff', this)"></div>
            </div>
          </div>

          <div class="style-row">
            <span>ì˜¤ë²„ë ˆì´ íˆ¬ëª…ë„ (ë°ê¸°):</span>
            <div class="opacity-row">
              <input type="range" id="overlayAlpha" class="opacity-slider" min="0" max="1" step="0.05" value="0.5" oninput="setOverlayAlpha(this.value)">
              <span id="overlayAlphaVal" class="opacity-val">50%</span>
            </div>
            <div class="alpha-btn-group" style="margin-top:5px;">
              <button class="btn-alpha" onclick="setOverlayAlpha(0.2)">ë°ê²Œ</button>
              <button class="btn-alpha" onclick="setOverlayAlpha(0.5)">ì¤‘ê°„</button>
              <button class="btn-alpha" onclick="setOverlayAlpha(0.8)">ì–´ë‘¡ê²Œ</button>
            </div>
          </div>
        </div>

        <hr style="border:0; border-top:1px dashed #cbd5e1; width:100%; margin:5px 0;">

        <div class="style-row"><span>ê¸€ììƒ‰:</span><div class="color-control-box"><div class="color-top-row"><div class="true-color-preview"><div id="text-preview" class="color-layer" style="background:#0f172a;"></div><input type="color" id="text-picker" value="#0f172a" oninput="handleColorInput('text', this.value)"></div><button class="btn-eyedropper" onclick="activateEyeDropper('text')">ğŸ–Šï¸</button><input type="text" id="text-text" class="hex-input" value="#0f172a" onchange="handleTextInput('text', this.value)"></div><div class="opacity-row"><input type="range" id="text-alpha" class="opacity-slider" min="0" max="1" step="0.01" value="1" oninput="handleAlphaInput('text', this.value)"><span id="text-alpha-val" class="opacity-val">100%</span></div></div></div>
        
        <div class="style-row" style="flex-direction:row; justify-content:space-between; align-items:center;"><span>ì—¬ë°± (Padding):</span><div style="display:flex; align-items:center; gap:5px;"><input type="range" id="paddingRange" min="0" max="100" value="32" oninput="updateCardStyle()" style="width:100px;"><span id="paddingVal" style="font-size:12px; width:35px; text-align:right;">32px</span></div></div>
      </div>

      <div id="block-list"></div>

      <div style="display: flex; justify-content: space-between; margin-bottom:10px;">
        <button class="btn-add-text" onclick="addTextBlock()">ğŸ“ ê¸€ ì¶”ê°€</button>
        <button class="btn-add-image" onclick="document.getElementById('imgFileInput').click()">ğŸ–¼ï¸ ì‚¬ì§„ ì¶”ê°€</button>
      </div>
      
      <button class="btn-save" onclick="saveImage()">ğŸ“¸ ì¹´ë“œ ì €ì¥í•˜ê¸°</button>
      <input type="file" id="imgFileInput" accept="image/*">
    </div>
  </div>

  <div class="preview-container">
    <div id="capture-area"></div>
  </div>

  <script>
    // --- V18 ìƒíƒœ ê´€ë¦¬ ---
    const presets=[{name:'ê¸°ë³¸',c1:'#fbfdff',c2:'#f1f5f9',t:'#0f172a'},{name:'ìƒˆë²½ë…˜',c1:'#e0f2fe',c2:'#f0f9ff',t:'#0c4a6e'},{name:'í”¼ì¹˜',c1:'#fff1f2',c2:'#fff7ed',t:'#881337'},{name:'ë¯¸ë“œë‚˜ì‡',c1:'#0f172a',c2:'#1e293b',t:'#f8fafc'},{name:'ë°˜íˆ¬ëª…ë¸”ë™',c1:'#000000',c2:'#000000',t:'#ffffff',a1:0.8,a2:0.9}];
    
    // ìŠ¤íƒ€ì¼ ìƒíƒœ
    let bgState = {
      mode: 'gradient', // 'gradient' or 'image'
      grad: { c1: '#fbfdff', a1: 1, c2: '#f1f5f9', a2: 1, angle: 235 },
      img: { data: null, size: 'cover', overlayColor: '#000000', overlayAlpha: 0.5 }
    };
    let colors = { text: { hex: '#0f172a', alpha: 1 } };
    let cardParams = { padding: 32, font: 'Pretendard, sans-serif' };
    
    let isEditorOpen = true;
    let blocks = [{type:'text',content:`<p style="font-size:1.1em; font-weight:bold;">V18 ë°°ê²½ ì´ë¯¸ì§€ ê¸°ëŠ¥!</p><p>ìŠ¤íƒ€ì¼ ê¾¸ë¯¸ê¸° > ë°°ê²½ ì´ë¯¸ì§€ íƒ­ì—ì„œ ì›í•˜ëŠ” ì‚¬ì§„ì„ ì—…ë¡œë“œí•´ë³´ì„¸ìš”.</p><p>ì˜¤ë²„ë ˆì´ íˆ¬ëª…ë„ë¥¼ ì¡°ì ˆí•˜ë©´ ê¸€ì”¨ê°€ ì•„ì£¼ ì˜ ë³´ì…ë‹ˆë‹¤.</p>`,isEditMode:true}];

    window.onload = function() { initPresets(); renderBlocks(); updatePreview(); }

    // --- íƒ­ ì „í™˜ ë¡œì§ ---
    function switchBgMode(mode) {
      bgState.mode = mode;
      
      // íƒ­ UI ë³€ê²½
      document.getElementById('tabGradient').className = mode==='gradient'?'tab-btn active':'tab-btn';
      document.getElementById('tabImage').className = mode==='image'?'tab-btn active':'tab-btn';
      
      // ì„¹ì…˜ í‘œì‹œ ë³€ê²½
      document.getElementById('sectionGradient').className = mode==='gradient'?'bg-mode-section active':'bg-mode-section';
      document.getElementById('sectionImage').className = mode==='image'?'bg-mode-section active':'bg-mode-section';
      
      updateCardStyle();
    }

    // --- ë°°ê²½ ì´ë¯¸ì§€ ë¡œì§ ---
    function handleBgImageUpload(input) {
      const file = input.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        bgState.img.data = e.target.result;
        updateCardStyle();
      };
      reader.readAsDataURL(file);
    }
    
    function setBgSize(size) {
      bgState.img.size = size;
      document.getElementById('btnCover').className = size==='cover'?'btn-fit active':'btn-fit';
      document.getElementById('btnContain').className = size==='contain'?'btn-fit active':'btn-fit';
      updateCardStyle();
    }
    
    function setOverlayColor(color, btn) {
      bgState.img.overlayColor = color;
      // ë²„íŠ¼ UI ê°±ì‹ 
      const btns = document.querySelectorAll('.btn-overlay-color');
      btns.forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      updateCardStyle();
    }
    
    function setOverlayAlpha(val) {
      bgState.img.overlayAlpha = parseFloat(val);
      document.getElementById('overlayAlpha').value = val;
      document.getElementById('overlayAlphaVal').innerText = Math.round(val*100) + '%';
      updateCardStyle();
    }

    // --- í†µí•© ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸ (í•µì‹¬) ---
    function updateCardStyle() {
      cardParams.padding = document.getElementById('paddingRange').value;
      cardParams.font = document.getElementById('fontSelect').value;
      document.getElementById('paddingVal').innerText = cardParams.padding + 'px';
      
      // í…ìŠ¤íŠ¸ ìƒ‰ìƒ ê³„ì‚°
      const tc = hexToRgba(colors.text.hex, colors.text.alpha);

      // ë°°ê²½ ìŠ¤íƒ€ì¼ ê³„ì‚°
      let backgroundStyle = '';
      
      if (bgState.mode === 'gradient') {
        const c1 = hexToRgba(bgState.grad.c1, bgState.grad.a1);
        const c2 = hexToRgba(bgState.grad.c2, bgState.grad.a2);
        bgState.grad.angle = document.getElementById('gradAngle').value;
        document.getElementById('gradAngleVal').innerText = bgState.grad.angle + 'Â°';
        backgroundStyle = `background: linear-gradient(${bgState.grad.angle}deg, ${c1} 0%, ${c2} 100%);`;
      } else {
        // ì´ë¯¸ì§€ ëª¨ë“œ (ì˜¤ë²„ë ˆì´ + ì´ë¯¸ì§€)
        if (bgState.img.data) {
           const overlay = hexToRgba(bgState.img.overlayColor, bgState.img.overlayAlpha);
           // linear-gradientë¥¼ ì˜¤ë²„ë ˆì´ë¡œ ì‚¬ìš©
           backgroundStyle = `
             background-image: linear-gradient(${overlay}, ${overlay}), url('${bgState.img.data}');
             background-size: ${bgState.img.size};
             background-position: center;
             background-repeat: no-repeat;
           `;
        } else {
           backgroundStyle = `background: #e2e8f0;`; // ì´ë¯¸ì§€ ì—†ì„ ë•Œ ê¸°ë³¸ íšŒìƒ‰
        }
      }

      // ìµœì¢… í”„ë ˆì„ ìŠ¤íƒ€ì¼
      const frameStyle = `width: ${document.getElementById('cardWidthInput').value}px; padding: ${cardParams.padding}px; ${backgroundStyle} color: ${tc}; font-family: ${cardParams.font};`;
      
      const captureArea = document.getElementById('capture-area');
      let fullHtml = `<div class="card-frame" style="${frameStyle}">`;
      blocks.forEach(block => {
        if (block.type === 'text') fullHtml += `<div class="text-part">${block.content}</div>`;
        else fullHtml += `<div style="margin: 1.5em 0; text-align: center;"><img src="${block.content}" style="width: ${block.width || 100}%; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display:inline-block;"></div>`;
      });
      fullHtml += `</div>`;
      captureArea.innerHTML = fullHtml;
    }

    // --- ê¸°ì¡´ ìƒ‰ìƒ í•¸ë“¤ë§ (ê·¸ë¼ë°ì´ì…˜ìš©) ---
    function handleColorInput(id, hexVal) {
      if(id === 'text') { colors.text.hex = hexVal; }
      else if(id === 'bg1') { bgState.grad.c1 = hexVal; }
      else if(id === 'bg2') { bgState.grad.c2 = hexVal; }
      updateUI(id); updateCardStyle();
    }
    function handleAlphaInput(id, alphaVal) {
      if(id === 'text') { colors.text.alpha = parseFloat(alphaVal); }
      else if(id === 'bg1') { bgState.grad.a1 = parseFloat(alphaVal); }
      else if(id === 'bg2') { bgState.grad.a2 = parseFloat(alphaVal); }
      updateUI(id); updateCardStyle();
    }
    // í…ìŠ¤íŠ¸ ì¸í’‹ ì²˜ë¦¬ ìƒëµ (ìœ„ ë¡œì§ê³¼ ë™ì¼í•˜ê²Œ ì—°ê²°ë¨)

    function updateUI(id) {
       // ìƒ‰ìƒ ì¸í’‹ UI ë™ê¸°í™” (ê¸°ì¡´ ì½”ë“œ ì°¸ì¡°)
       let hex, alpha;
       if(id==='text') { hex=colors.text.hex; alpha=colors.text.alpha; }
       else if(id==='bg1') { hex=bgState.grad.c1; alpha=bgState.grad.a1; }
       else if(id==='bg2') { hex=bgState.grad.c2; alpha=bgState.grad.a2; }
       
       const rgba = hexToRgba(hex, alpha);
       const elPreview = document.getElementById(`${id}-preview`);
       if(elPreview) elPreview.style.backgroundColor = rgba;
       // ... ë‚˜ë¨¸ì§€ UI ê°±ì‹ 
    }

    // --- ìœ í‹¸ë¦¬í‹° ë° ê¸°íƒ€ í•¨ìˆ˜ë“¤ (ì´ì „ ë²„ì „ê³¼ ë™ì¼) ---
    function hexToRgba(hex, alpha) {
      let r=0,g=0,b=0;
      if (hex.length===4) { r=parseInt(hex[1]+hex[1],16); g=parseInt(hex[2]+hex[2],16); b=parseInt(hex[3]+hex[3],16); }
      else if(hex.length>=7) { r=parseInt(hex.substring(1,3),16); g=parseInt(hex.substring(3,5),16); b=parseInt(hex.substring(5,7),16); }
      return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }
    
    function toggleEditor() {
      isEditorOpen = !isEditorOpen;
      const content = document.getElementById('editorContent');
      const icon = document.getElementById('foldIcon');
      if(isEditorOpen) { content.classList.remove('collapsed'); icon.innerText = 'ğŸ”½'; }
      else { content.classList.add('collapsed'); icon.innerText = 'ğŸ”¼'; }
    }
    function toggleStylePanel() { document.getElementById('stylePanel').classList.toggle('open'); }
    
    // í”„ë¦¬ì…‹ ë¡œì§ (ê·¸ë¼ë°ì´ì…˜ ëª¨ë“œë¡œ ê°•ì œ ì „í™˜)
    function initPresets() {
      const c = document.getElementById('presetList'); c.innerHTML = '';
      presets.forEach(p => {
        const b = document.createElement('div'); b.className = 'btn-preset';
        b.style.background = `linear-gradient(135deg, ${p.c1}, ${p.c2})`;
        b.onclick = () => { 
           switchBgMode('gradient'); // í”„ë¦¬ì…‹ì€ ê·¸ë¼ë°ì´ì…˜ ëª¨ë“œ
           bgState.grad.c1 = p.c1; bgState.grad.c2 = p.c2; colors.text.hex = p.t;
           if(p.a1) bgState.grad.a1 = p.a1; if(p.a2) bgState.grad.a2 = p.a2;
           updateUI('bg1'); updateUI('bg2'); updateUI('text'); updateCardStyle();
        };
        c.appendChild(b);
      });
    }

    // ... ë¸”ë¡ ë Œë”ë§, ì €ì¥, ì¶”ì¶œ ë“± ë‚˜ë¨¸ì§€ í•¨ìˆ˜ëŠ” V17ê³¼ ë™ì¼í•˜ê²Œ í¬í•¨ ...
    // (ì§€ë©´ ê´€ê³„ìƒ í•µì‹¬ ë³€ê²½ ì‚¬í•­ ìœ„ì£¼ë¡œ ì‘ì„±í–ˆìŠµë‹ˆë‹¤. ì‹¤ì œ êµ¬ë™ ì‹œì—ëŠ” V17ì˜ í•¨ìˆ˜ë“¤ì„ ê·¸ëŒ€ë¡œ ì•„ë˜ì— ë¶™ì—¬ë„£ìœ¼ì‹œë©´ ë©ë‹ˆë‹¤.)
    
    // í•„ìˆ˜ í•¨ìˆ˜ ë³µêµ¬
    function renderBlocks(){const container=document.getElementById('block-list');container.innerHTML='';blocks.forEach((block,index)=>{const div=document.createElement('div');div.className=`block-item ${block.type==='text'?'text-block':'image-block'}`;const canMergeUp=index>0&&blocks[index-1].type==='text'&&block.type==='text';let innerHTML=`<div class="block-header"><div class="block-title">${block.type==='text'?'ğŸ“ í…ìŠ¤íŠ¸':'ğŸ–¼ï¸ ì´ë¯¸ì§€'} <span style="font-weight:normal;font-size:11px;">#${index+1}</span></div><div class="block-controls"><button class="btn-sm" onclick="moveBlock(${index},-1)">â¬†ï¸</button><button class="btn-sm" onclick="moveBlock(${index},1)">â¬‡ï¸</button><button class="btn-sm btn-danger" onclick="deleteBlock(${index})">ì‚­ì œ</button></div></div>`;if(block.type==='text'){innerHTML+=`<div style="margin-bottom:5px; display:flex; justify-content:flex-end; gap:5px; flex-wrap:wrap;"><button class="btn-sm btn-extract" onclick="smartExtract(${index})" title="ìŠ¤íƒ€ì¼ ì¶”ì¶œ">ğŸ§™â€â™‚ï¸ ìŠ¤ë§ˆíŠ¸ ì¶”ì¶œ</button>${canMergeUp?`<button class="btn-sm btn-merge" onclick="mergeUp(${index})">ğŸ§´ í’€ì¹ </button>`:''}${block.isEditMode?`<button class="btn-sm btn-split" onmousedown="splitBlock(event, ${index})">âœ‚ï¸ ìë¥´ê¸°</button>`:''}<button class="btn-sm btn-edit-toggle" onclick="toggleEditMode(${index})">${block.isEditMode?'ğŸ‘ï¸ ë¯¸ë¦¬ë³´ê¸°':'âœï¸ ìˆ˜ì •'}</button></div><div class="block-preview-box ${!block.isEditMode?'active':''}" onclick="toggleEditMode(${index})">${block.content||'<span style="color:#999">(ë‚´ìš© ì—†ìŒ)</span>'}</div><textarea id="editor-${index}" class="code-editor ${block.isEditMode?'active':''}" oninput="updateText(${index}, this.value)">${block.content}</textarea>`;}else{innerHTML+=`<div style="margin-bottom:5px;display:flex;justify-content:flex-end;"><button class="btn-sm btn-edit-toggle" onclick="toggleEditMode(${index})">${block.isEditMode?'ğŸ‘ï¸ ì‚¬ì§„':'âš™ï¸ ì„¤ì •'}</button></div><div class="${!block.isEditMode?'active':''}" style="display:${!block.isEditMode?'block':'none'};text-align:center;"><img src="${block.content}" style="max-width:100%;height:auto;border-radius:8px;"></div><div class="${block.isEditMode?'active':''}" style="display:${block.isEditMode?'block':'none'};"><div style="display:flex;gap:10px;align-items:center;margin-bottom:5px;"><img src="${block.content}" class="editor-img-preview"><div><span style="font-size:12px;">ë„ˆë¹„:</span><input type="number" value="${block.width||100}" onchange="updateImageWidth(${index},this.value)" style="width:50px;text-align:center;">%</div></div></div>`;}div.innerHTML=innerHTML;container.appendChild(div);});blocks.forEach((block,idx)=>{if(block.type==='text'){const ta=document.getElementById(`editor-${idx}`);if(ta)ta.value=block.content;}});}
    function updateText(index,val){blocks[index].content=val;updatePreview();}
    function splitBlock(event,index){event.preventDefault();const textarea=document.getElementById(`editor-${index}`);if(!textarea)return;const currentContent=textarea.value;const cursorPosition=textarea.selectionStart;const firstPart=currentContent.substring(0,cursorPosition);const secondPart=currentContent.substring(cursorPosition);blocks[index].content=firstPart;blocks[index].isEditMode=true;blocks.splice(index+1,0,{type:'text',content:secondPart,isEditMode:true});renderBlocks();updatePreview();}
    function mergeUp(index){if(index<=0)return;if(confirm('í•©ì¹˜ì‹œê² ìŠµë‹ˆê¹Œ?')){blocks[index-1].content+=blocks[index].content;blocks.splice(index,1);renderBlocks();updatePreview();}}
    function toggleEditMode(index){blocks[index].isEditMode=!blocks[index].isEditMode;renderBlocks();}
    function addTextBlock(){blocks.push({type:'text',content:'<p>ìƒˆ ë¬¸ë‹¨</p>',isEditMode:true});renderBlocks();updatePreview();}
    document.getElementById('imgFileInput').addEventListener('change',function(e){const file=e.target.files[0];if(!file)return;const reader=new FileReader();reader.onload=function(event){blocks.push({type:'image',content:event.target.result,width:100,isEditMode:false});renderBlocks();updatePreview();e.target.value='';};reader.readAsDataURL(file);});
    function updateImageWidth(index,val){blocks[index].width=val;updatePreview();}
    function deleteBlock(index){if(confirm('ì‚­ì œ?')){blocks.splice(index,1);renderBlocks();updatePreview();}}
    function moveBlock(index,dir){const newIdx=index+dir;if(newIdx<0||newIdx>=blocks.length)return;[blocks[index],blocks[newIdx]]=[blocks[newIdx],blocks[index]];renderBlocks();updatePreview();}
    document.getElementById('cardWidthInput').addEventListener('input',updatePreview);
    async function activateEyeDropper(id){if(!window.EyeDropper){alert("PC í¬ë¡¬/ì—£ì§€ì—ì„œë§Œ ì§€ì›ë©ë‹ˆë‹¤.");return;}try{const ed=new EyeDropper();const res=await ed.open();handleColorInput(id, res.sRGBHex);}catch(e){}}
    function smartExtract(index){const content=blocks[index].content;const parser=new DOMParser();const doc=parser.parseFromString(content,'text/html');const wrapper=doc.body.firstElementChild;if(!wrapper||wrapper.tagName!=='DIV'){if(!confirm("ëª…í™•í•œ 'ê²‰í¬ì¥(div)'ì´ ì—†ìŠµë‹ˆë‹¤. ê·¸ë˜ë„ ë²—ê¸¸ê¹Œìš”?"))return;}if(wrapper.style&&confirm("ë°°ê²½ ìŠ¤íƒ€ì¼ì„ ì¶”ì¶œí•˜ì—¬ í˜„ì¬ ì„¤ì •ì„ ë®ì–´ì“¸ê¹Œìš”?")){const bg=wrapper.style.background;const colorMatch=bg.match(/#(?:[0-9a-fA-F]{3}){1,2}/g);if(colorMatch&&colorMatch.length>=2){handleColorInput('bg1',colorMatch[0]);handleColorInput('bg2',colorMatch[1]);}if(wrapper.style.color)handleColorInput('text',wrapper.style.color);switchBgMode('gradient');}blocks[index].content=wrapper.innerHTML.trim();renderBlocks();updatePreview();}
    function saveImage(){const element=document.getElementById("capture-area").firstElementChild;const btn=document.querySelector('.btn-save');const txt=btn.innerText;btn.innerText="â³ ë³€í™˜ ì¤‘...";htmlToImage.toPng(element,{pixelRatio:2}).then(function(dataUrl){const link=document.createElement('a');link.download='novel_card_'+Date.now()+'.png';link.href=dataUrl;link.click();btn.innerText=txt;}).catch(function(error){alert("ì €ì¥ ì‹¤íŒ¨");btn.innerText=txt;});}
    function savePresetToFile() {const data={colors,cardParams,bgState}; const blob=new Blob([JSON.stringify(data)],{type:"application/json"}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download="novel_card_preset.json"; a.click();}
    function loadPresetFromFile(input) {const file=input.files[0]; if(!file)return; const reader=new FileReader(); reader.onload=function(e){try{const data=JSON.parse(e.target.result); if(data.colors&&data.cardParams){colors=data.colors;cardParams=data.cardParams; if(data.bgState) bgState=data.bgState; updateUI('bg1');updateUI('bg2');updateUI('text'); document.getElementById('fontSelect').value=cardParams.font; document.getElementById('paddingRange').value=cardParams.padding; switchBgMode(bgState.mode); updateCardStyle(); alert("ì„¤ì •ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!");}}catch(err){alert("íŒŒì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");}}; reader.readAsText(file); input.value='';}
  </script>
</body>
</html>
